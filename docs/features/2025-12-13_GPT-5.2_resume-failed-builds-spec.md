# Resume Failed Builds Feature Specification
**Date:** 2025-12-13  
**Source:** GPT-5.2  
**Status:** Proposed (for future implementation)

## Problem Statement

Currently, when a build fails (e.g., due to API rate limits, network issues, or sandbox timeout), the user has only two options:

1. **Restart** - Creates a completely new build from scratch
2. **Abandon** - Leave the failed build as-is

This is wasteful because:
- The agent may have completed significant work before failure
- Progress stored in `feature_list.json` shows what was done vs. remaining
- Dependencies were already installed
- Files were already created

## Existing Support in Codebase

The sandbox-agent already has logic to detect and continue from existing progress:

```typescript
// From sandbox-agent.ts (lines 423-433)
let isFirstRun = true;
try {
  await sandbox.readFile('/home/user/feature_list.json');
  isFirstRun = false;
  onLog('info', 'Found existing feature_list.json - continuing...');
  
  const progress = await getProgress(sandbox);
  onProgress(progress.completed, progress.total);
} catch {
  onLog('info', 'Starting fresh project...');
}
```

The agent sends different prompts based on `isFirstRun`:
- First run: "Read app_spec.txt and create feature_list.json..."
- Continuation: "Check feature_list.json and continue implementing..."

## The Blocker

When a build fails, the sandbox is destroyed (to avoid runaway costs). The artifacts are saved to S3/MinIO, but there's no way to:

1. Restore those artifacts to a new sandbox
2. Resume the same build ID with the restored state

## Proposed Solution

### Approach: "Resume" button that rehydrates from artifacts

```
User clicks "Resume" on failed build
  → Platform creates new sandbox
  → Downloads artifact zip from storage
  → Extracts to sandbox /home/user/
  → Runs agent with continuation prompt
  → Updates the SAME build record (not a new one)
  → User sees progress continue from where it left off
```

### Key Differences from "Restart"

| Aspect | Restart | Resume |
|--------|---------|--------|
| Build ID | New | Same |
| Progress | Reset to 0 | Continues from last state |
| Artifacts | Fresh start | Rehydrated from saved |
| Agent prompt | Initial | Continuation |

### Implementation Tasks

#### Phase 1: Sandbox Rehydration Capability

1. **Add `uploadDir` to Sandbox interface**
   ```typescript
   interface Sandbox {
     // ...existing methods...
     
     /**
      * Upload and extract an archive to the sandbox.
      * @param buffer - ZIP or TAR buffer to extract
      * @param destPath - Destination path in sandbox
      */
     uploadDir(buffer: Buffer, destPath: string): Promise<void>;
   }
   ```

2. **Implement for E2B provider**
   - E2B has `sandbox.files.write()` for individual files
   - May need to iterate through ZIP entries
   - Or use E2B's upload URL feature

#### Phase 2: Resume API Endpoint

Create `POST /api/builds/[id]/resume`:

```typescript
export async function POST(request: Request, { params }: RouteParams) {
  // 1. Verify build exists and is FAILED
  // 2. Verify user owns build
  // 3. Check artifacts exist
  // 4. Create new sandbox
  // 5. Download artifacts from storage
  // 6. Upload/extract to sandbox
  // 7. Update build status to RUNNING
  // 8. Start agent with continuation flag
  // 9. Return updated build
}
```

#### Phase 3: Build Runner Changes

Update `startBuildInBackground` to accept a `resume: boolean` flag:

```typescript
export async function startBuildInBackground(
  buildId: string,
  appSpec: string,
  sandboxProvider: string,
  harnessId: string,
  targetFeatureCount: number,
  options?: { resume?: boolean; existingSandbox?: Sandbox }
): Promise<void>
```

When `resume: true`:
- Skip spec writing (already in sandbox)
- Agent will detect feature_list.json and continue

#### Phase 4: UI Changes

1. **Add "Resume" button** to BuildMonitor for FAILED builds
   - Only show if `artifactKey` exists
   - Different from "Restart" button

2. **Resume confirmation dialog**
   - "Resume from {X}/{Y} features completed?"
   - Show warning about potential state issues

3. **Progress indicator**
   - Show "(Resumed)" badge
   - Start progress bar from last position

### Data Model

No schema changes required. The existing `Build` model already has:
- `artifactKey` - for finding saved artifacts
- `progress` - for tracking completion
- `status` - can transition FAILED → RUNNING

### Edge Cases to Handle

1. **Corrupted artifacts** - Agent might fail again if state is inconsistent
2. **Outdated agent** - Agent version may have changed since original build
3. **Concurrent resumes** - Rate limit to prevent multiple resume attempts
4. **Missing files** - feature_list.json might reference files that weren't saved

### Validation Strategy

Before resuming, verify:
1. `feature_list.json` exists in artifacts
2. At least one feature marked as `passes: true`
3. Essential files exist (app_spec.txt, package.json, etc.)

### Alternative: "Resume with Fresh Agent"

For cases where the agent got stuck, offer:
- **Resume (continue)** - Tries to finish remaining features
- **Resume (retry last)** - Marks last feature as failed, retries it

## Priority Assessment

**Medium-High Priority**

- High value for long builds (production tier, 150+ features)
- Reduces cost and time waste from failures
- Improves user experience significantly
- Relatively contained implementation scope

## Dependencies

- Artifact storage must be working (already implemented)
- Preview feature provides similar sandbox creation patterns

## Timeline Estimate

- Phase 1 (Sandbox rehydration): 1-2 hours
- Phase 2 (Resume API): 1-2 hours  
- Phase 3 (Build runner): 1 hour
- Phase 4 (UI): 1-2 hours
- Testing: 1-2 hours

**Total: 5-9 hours**

