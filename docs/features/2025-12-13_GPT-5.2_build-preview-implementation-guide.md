# Build Preview Implementation Guide
**Date:** 2025-12-13  
**Source:** GPT-5.2  
**Related:** `2025-12-12_GPT-5.2_build-preview-sandbox-proposal.md`

## Implementation Strategy

### Approach: Feature Branch + Phased Development

**Branch structure:**
```
main (production-ready)
  ‚îî‚îÄ‚îÄ feature/build-preview (preview feature work)
       ‚îú‚îÄ‚îÄ phase-1-sandbox-interface
       ‚îú‚îÄ‚îÄ phase-2-preview-apis
       ‚îú‚îÄ‚îÄ phase-3-ui-integration
       ‚îî‚îÄ‚îÄ phase-4-safety-rails
```

### Why feature branch (not fork)?
- Single repo, cleaner history
- Easy to keep in sync with main
- Claude maintains context better
- One PR when ready to merge

---

## Backwards Compatibility Strategy

### Design principle: Graceful degradation
**New builds**: Full preview support (sandbox kept alive, `outputUrl` populated)  
**Old builds**: Preview unavailable (only download ZIP, no preview button)

### Detection mechanism
```typescript
// In UI components
const canPreview = build.outputUrl || build.sandboxId;

// In API
if (!build.outputUrl) {
  return NextResponse.json(
    { error: 'Preview not available for builds created before preview feature' },
    { status: 404 }
  );
}
```

### Migration path (optional, later)
For important old builds, could add "Rebuild with Preview" button that:
1. Takes the saved `appSpec`
2. Launches a new build with preview enabled
3. Links to the original build

---

## Phased Implementation Plan

### Phase 1: Sandbox Interface Extensions ‚öôÔ∏è
**Goal:** Add port exposure capability to sandbox abstraction

**Tasks:**
- [ ] Update `Sandbox` interface in `packages/sandbox-providers/src/interface.ts`
  - Add `exposePort(port: number): Promise<string>` method
  - Add `getPublicUrl(port: number): Promise<string | null>` method
- [ ] Implement for E2B provider (`packages/sandbox-providers/src/e2b.ts`)
  - Research E2B SDK port exposure API
  - Wrap port exposure in provider
  - Add error handling for unsupported cases
- [ ] Add unit tests for new interface methods
- [ ] Update provider documentation

**Claude can help:** Implement interface changes + E2B wrapper

**Commit checkpoint:** `feat(sandbox): add port exposure interface and E2B impl`

---

### Phase 2: Preview API Routes üîå
**Goal:** Backend APIs for starting/stopping/checking preview

**Tasks:**
- [ ] Add preview DB fields (optional, can use existing):
  ```prisma
  // Already exists in Build model:
  // sandboxId       String?
  // outputUrl       String?
  
  // Optional additions for better lifecycle:
  previewStatus     String?  // 'running' | 'stopped' | 'expired'
  previewExpiresAt  DateTime?
  previewPort       Int?      @default(3000)
  ```

- [ ] Create `apps/web/src/app/api/builds/[id]/preview/route.ts`
  - `POST` - Start preview (keep sandbox alive, expose port, save URL)
  - `GET` - Get preview status
  - `DELETE` - Stop preview (destroy sandbox)

- [ ] Create `apps/web/src/lib/sandbox/preview-manager.ts`
  - `startPreview(buildId, sandbox)` - detect framework, run server, expose port
  - `stopPreview(buildId)` - cleanup sandbox
  - Framework detection utilities (Next.js, Vite, static, etc.)

- [ ] Update `build-runner.ts` to conditionally keep sandbox alive
  - Add config flag: `enablePreview: boolean`
  - If enabled: skip `sandbox.destroy()`, populate `outputUrl`
  - If disabled: destroy as today

**Claude can help:** Write all API routes + preview manager logic

**Commit checkpoint:** `feat(api): add build preview endpoints and manager`

---

### Phase 3: UI Integration üé®
**Goal:** Add preview UI components to build detail page

**Tasks:**
- [ ] Update `apps/web/src/components/build/build-monitor.tsx`
  - Add preview section in right sidebar
  - Show preview status badge
  - Add "Open Preview" / "Stop Preview" buttons
  - Handle loading/error states

- [ ] Create `apps/web/src/components/build/preview-panel.tsx`
  - Preview URL display with copy button
  - Status indicator (Running/Stopped/Expired)
  - Countdown timer for expiry
  - Framework detection display
  - Actions: Open, Stop, Restart

- [ ] Add backwards compatibility checks
  ```tsx
  {build.outputUrl ? (
    <PreviewPanel buildId={build.id} outputUrl={build.outputUrl} />
  ) : (
    <div className="text-muted-foreground">
      Preview not available for this build
    </div>
  )}
  ```

- [ ] Update dashboard to show preview availability indicator

**Claude can help:** Build all UI components + integrate into existing pages

**Commit checkpoint:** `feat(ui): add build preview panel and controls`

---

### Phase 4: Safety Rails & Polish üõ°Ô∏è
**Goal:** Production-ready safety, quotas, and cleanup

**Tasks:**
- [ ] Add preview quotas
  - Max concurrent previews per user
  - Max preview duration (default: 60 minutes)
  - Auto-expire logic

- [ ] Create cleanup job (`apps/web/src/lib/sandbox/preview-cleanup.ts`)
  - Cron job or API route with token auth
  - Find expired previews
  - Destroy sandboxes
  - Update DB status

- [ ] Add monitoring/logging
  - Preview start/stop events
  - Sandbox lifecycle tracking
  - Cost estimation per preview

- [ ] Security hardening
  - Verify user owns build before allowing preview actions
  - Rate limit preview API routes
  - Add preview URL access logging

- [ ] Documentation
  - Update README with preview feature
  - Add user guide for preview feature
  - Document preview API endpoints

**Claude can help:** Implement safety logic + cleanup jobs

**Commit checkpoint:** `feat(preview): add safety rails and cleanup`

---

## Working with Claude: Suggested Workflow

### Session-by-session approach
Each session with Claude can tackle one phase or sub-task:

**Example Session 1:**
```
"Let's implement Phase 1: Sandbox Interface Extensions. 
Start by updating the Sandbox interface to add port exposure methods."
```

**Example Session 2:**
```
"Now let's build the preview manager (Phase 2). 
Create preview-manager.ts with framework detection and server startup logic."
```

### Benefits of this approach
- ‚úÖ Clear checkpoints (commit after each phase)
- ‚úÖ Easy to review incremental progress
- ‚úÖ Can test each phase before moving on
- ‚úÖ If something breaks, easy to isolate

---

## Testing Strategy

### Phase 1 Testing
- Create sandbox, expose port, verify URL returned
- Test with E2B directly

### Phase 2 Testing
- Hit API routes with curl/Postman
- Verify sandbox stays alive after build
- Check outputUrl populated correctly

### Phase 3 Testing
- Load build detail page
- Click preview buttons
- Verify UI states (loading, success, error)
- Test old build (no outputUrl) - should show "not available"

### Phase 4 Testing
- Leave preview running, wait for expiry
- Check cleanup job works
- Verify quotas enforced

---

## Rollout Plan

### Development (feature branch)
```bash
git checkout -b feature/build-preview
# Work through phases 1-4
# Commit after each phase
# Test thoroughly
```

### Staging/Testing
```bash
# Merge to staging branch or deploy feature branch
# Run real builds with preview enabled
# Verify new builds get preview
# Verify old builds gracefully degrade
```

### Production
```bash
# Create PR: feature/build-preview ‚Üí main
# Review changes
# Merge and deploy
```

### Feature flag (optional, recommended)
Add environment variable to control rollout:
```env
ENABLE_BUILD_PREVIEW=true
```

This lets you:
- Deploy code without activating feature
- Enable for subset of users first
- Quick rollback if issues found

---

## Backwards Compatibility Checklist

- [ ] Old builds still load without errors
- [ ] Download ZIP still works for all builds
- [ ] Preview section only shows when `outputUrl` exists
- [ ] API gracefully returns 404 for old builds
- [ ] No migration required for existing DB records

---

## Next Steps

1. **Create feature branch:**
   ```bash
   cd autonomous-agents-platform
   git checkout -b feature/build-preview
   ```

2. **Start with Phase 1:**
   Update sandbox interface and E2B implementation

3. **Work incrementally:**
   Complete one phase, commit, test, move to next

4. **Engage Claude for each phase:**
   Provide clear context about which phase you're working on

